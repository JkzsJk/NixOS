= Deluge Module =

BitTorrent client with WireGuard VPN isolation via network namespace.

== Structure ==

<pre>
02-deluge/
  ├─ default.nix        - Entry point (imports all modules)
  ├─ 00-packages.nix    - Deluge packages and network tools
  ├─ 01-options.nix     - Module options definitions
  ├─ 02-namespace.nix   - Network namespace setup
  ├─ 03-wireguard.nix   - VPN configuration
  ├─ 04-service.nix     - Deluge daemon and proxy socket
  └─ 05-web.nix         - Web UI configuration
</pre>

== Architecture ==

The Deluge module uses '''Linux network namespaces''' to ensure ALL Deluge traffic goes through the VPN:

* '''Isolated Namespace''': Creates a separate network namespace for Deluge
* '''VPN Connection''': Establishes a WireGuard VPN interface (wg-deluge) inside the isolated namespace
* '''No Leaks''': Without a working VPN connection, the namespace has no internet access
* '''System Isolation''': The rest of your system uses normal internet - only Deluge uses the VPN
* '''Proxy Access''': The Deluge web UI and RPC are accessible from the host system via systemd-socket-proxyd

This architecture guarantees that if the VPN fails, Deluge cannot leak your real IP address.

<pre>
┌───────────────────────────────────────────┐
│ Root Namespace (Normal Network)           │
│                                           │
│  ┌──────────────┐    ┌──────────────┐     │
│  │ Deluge Web   │───▶│ Proxy Socket │     │
│  │ (Port 8112)  │    │ (Port 58846) │     │
│  └──────────────┘    └───────┬──────┘     │
│                              │            │
└──────────────────────────────┼────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │ VPN Namespace        ▼                      │
        │                                             │
        │  ┌─────────────┐    ┌──────────────────┐    │
        │  │ WireGuard   │───▶│ Deluge Daemon    │    │
        │  │ wg-deluge   │    │ (Isolated)       │    │
        │  └─────────────┘    └──────────────────┘    │
        │                                             │
        └─────────────────────────────────────────────┘
                               │
                               ▼
                          VPN Server
                               │
                               ▼
                           Internet
</pre>

== Modules ==

=== 00-packages.nix ===
* Adds Deluge and GTK client to system packages
* Network namespace utilities (iproute2, wireguard-tools)

=== 01-options.nix ===
* Defines all module options
* Service configuration (enable, dataDir, downloadDir)
* Web UI settings (port, firewall)
* VPN namespace configuration (interface, addresses, DNS)

=== 02-namespace.nix ===
* Creates isolated network namespace
* Systemd service for namespace lifecycle

=== 03-wireguard.nix ===
* Configures WireGuard interface in namespace
* Sets up routing and DNS within namespace
* IPv4/IPv6 support

=== 04-service.nix ===
* Deluge daemon service bound to VPN namespace
* Socket proxy for root namespace access
* User/group and permissions management

=== 05-web.nix ===
* Web UI running in root namespace
* Connects to daemon via proxy socket

== Features ==

* '''Kill Switch''': Daemon stops if VPN disconnects
* '''IP Isolation''': Only VPN traffic; no leaks
* '''Web UI''': Access from any device on LAN
* '''Auto-restart''': Recovers from VPN failures

== Usage ==

=== 1. Get WireGuard Config ===

Obtain from VPN provider (Mullvad, ProtonVPN, etc.):

<source lang="ini">
[Interface]
PrivateKey = YOUR_PRIVATE_KEY
Address = 10.8.0.2/24

[Peer]
PublicKey = SERVER_PUBLIC_KEY
Endpoint = vpn.server.com:51820
AllowedIPs = 0.0.0.0/0
</source>

Save to <code>/root/wireguard-deluge.conf</code> (secure with <code>chmod 600</code>).

'''Step 2:''' Enable Deluge:

<source lang="nix">
imports = [
  ../../modules/02-deluge
];

myServices.deluge = {
  enable = true;
  downloadDir = "/srv/torrents";
  
  web = {
    enable = true;
    port = 8112;
    openFirewall = true;
  };
  
  vpn = {
    useSharedConfig = false;  # Standalone mode
    configFile = /root/wireguard-deluge.conf;
    address = "10.8.0.2/24";  # Must match config file
    endpoint = "vpn.provider.com:51820";  # Must match config file
  };
};
</source>

=== Method 3: Standalone with Separate Key File ===

'''Step 1:''' Generate and save keys:

<source lang="bash">
# Generate private key
wg genkey | sudo tee /root/wireguard-deluge.key
sudo chmod 600 /root/wireguard-deluge.key

# Get public key to share with VPN provider
sudo cat /root/wireguard-deluge.key | wg pubkey
</source>

'''Step 2:''' Configure Deluge with individual options:

<source lang="nix">
myServices.deluge = {
  enable = true;
  downloadDir = "/srv/torrents";
  
  web.enable = true;
  
  vpn = {
    useSharedConfig = false;
    privateKeyFile = "/root/wireguard-deluge.key";
    publicKey = "SERVER_PUBLIC_KEY";  # From VPN provider
    endpoint = "vpn.provider.com:51820";
    address = "10.8.0.2/24";  # From VPN provider
    dns = [ "10.8.0.1" ];
  };
};
</source>

=== Rebuild System ===

<source lang="bash">
sudo nixos-rebuild switch
</source>

== Access ==

* '''Web UI''': <code>http://localhost:8112</code>
* '''Default password''': <code>deluge</code> (change immediately)

== Verification ==

=== Check VPN Connection ===

<source lang="bash">
# Show namespace
sudo ip netns list

# Check WireGuard status in namespace
sudo ip netns exec delugevpn wg show

# Verify routing (should only show VPN interface)
sudo ip netns exec delugevpn ip route
</source>

=== Test IP Leak Protection ===

<source lang="bash">
# Get VPN IP (should be different from your real IP)
sudo ip netns exec delugevpn curl -s https://api.ipify.org

# Compare to your real IP
curl -s https://api.ipify.org
</source>

=== Check Services ===

<source lang="bash">
systemctl status deluged
systemctl status delugeweb
systemctl status proxy-to-deluged
systemctl status delugevpn-wireguard
</source>

== Troubleshooting ==

=== Daemon Won't Start ===

<source lang="bash">
# Check namespace exists
sudo ip netns list

# Verify WireGuard config syntax
sudo wg show all

# Check logs
journalctl -u deluged -f
journalctl -u delugevpn-wireguard -f
</source>

=== Web UI Can't Connect ===

<source lang="bash">
# Verify proxy socket
systemctl status proxy-to-deluged

# Check daemon is running
sudo ip netns exec delugevpn ss -tlnp | grep 58846
</source>

=== VPN Not Working ===

<source lang="bash">
# Test connectivity from namespace
sudo ip netns exec delugevpn ping -c 3 1.1.1.1

# Check WireGuard handshake
sudo ip netns exec delugevpn wg show
# Look for "latest handshake" - should be recent
</source>

== Options ==

=== VPN Configuration Modes ===

The Deluge module supports three modes for VPN configuration:

'''Mode 1: Reuse Credentials from WireGuard Module'''

Copies VPN credentials (private key, public key, endpoint, addresses) from the <code>myServices.wireguard</code> module. '''Important''': This creates a SEPARATE VPN connection in an isolated namespace. It does NOT share the WireGuard module's connection - only the credentials.

* Use when: You have both system-wide VPN and Deluge VPN from the same provider
* Result: Two VPN connections (one in root namespace for system, one in isolated namespace for Deluge only)
* System traffic: Uses normal internet OR WireGuard module connection (if enabled)
* Deluge traffic: Uses separate isolated VPN connection with copied credentials

<source lang="nix">
myServices.deluge.vpn = {
  useSharedConfig = true;
  wireguardInterface = "wg0";  # Interface name from myServices.wireguard
  # All other settings copied automatically from wg0 configuration
};
</source>

'''Mode 2: Standalone Config File'''

Uses a complete WireGuard configuration file.

* Use when: You have a complete <code>.conf</code> file from your VPN provider
* Result: Single VPN connection only for Deluge in isolated namespace
* System traffic: Uses normal internet

<source lang="nix">
myServices.deluge.vpn = {
  useSharedConfig = false;
  configFile = /root/wireguard-deluge.conf;
  address = "10.8.0.2/24";  # Must match config file
  endpoint = "vpn.provider.com:51820";  # Must match config file
};
</source>

'''Mode 3: Standalone Separate Options'''

Uses individual NixOS options for each setting.

* Use when: You want NixOS to manage the configuration explicitly
* Result: Single VPN connection only for Deluge in isolated namespace
* System traffic: Uses normal internet

<source lang="nix">
myServices.deluge.vpn = {
  useSharedConfig = false;
  privateKeyFile = "/root/wireguard-deluge.key";
  publicKey = "SERVER_PUBLIC_KEY";
  endpoint = "vpn.provider.com:51820";
  address = "10.8.0.2/24";
  dns = [ "10.8.0.1" ];
};
</source>

=== All Options ===

* <code>myServices.deluge.enable</code> - Enable Deluge with VPN isolation
* <code>myServices.deluge.dataDir</code> - Data directory (default: <code>/var/lib/deluge</code>)
* <code>myServices.deluge.downloadDir</code> - Download location (default: <code>/var/lib/deluge/downloads</code>)
* <code>myServices.deluge.openFirewall</code> - Open firewall for torrenting (default: false)
* <code>myServices.deluge.web.enable</code> - Enable web UI (default: true)
* <code>myServices.deluge.web.port</code> - Web UI port (default: 8112)
* <code>myServices.deluge.web.openFirewall</code> - Allow web access (default: true)
* <code>myServices.deluge.daemon.port</code> - Daemon port (default: 58846)
* <code>myServices.deluge.vpn.namespace</code> - Network namespace name (default: <code>delugevpn</code>)
* <code>myServices.deluge.vpn.interface</code> - WireGuard interface name in namespace (default: <code>wg-deluge</code>)
* <code>myServices.deluge.vpn.useSharedConfig</code> - Copy credentials from myServices.wireguard (default: false)
* <code>myServices.deluge.vpn.wireguardInterface</code> - WireGuard interface to copy credentials from (required if useSharedConfig=true)
* <code>myServices.deluge.vpn.configFile</code> - WireGuard config file path (Mode 2)
* <code>myServices.deluge.vpn.privateKeyFile</code> - Private key file (Mode 3)
* <code>myServices.deluge.vpn.publicKey</code> - Server public key (Mode 3)
* <code>myServices.deluge.vpn.address</code> - VPN IPv4 address/CIDR (Modes 2 & 3)
* <code>myServices.deluge.vpn.addressV6</code> - VPN IPv6 address (optional)
* <code>myServices.deluge.vpn.endpoint</code> - VPN server endpoint (Modes 2 & 3)
* <code>myServices.deluge.vpn.dns</code> - DNS servers for VPN namespace (default: <code>[]</code>)

== Security Notes ==

* WireGuard config contains secrets - protect with <code>chmod 600</code>
* Change default web UI password immediately
* Consider additional firewall rules for web UI
* Monitor failed login attempts: <code>journalctl -u delugeweb</code>
* All torrent traffic isolated to VPN namespace
* Kill switch prevents leaks if VPN disconnects
